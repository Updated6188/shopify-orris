{%- comment -%}
  Fake Recent Orders Popup (Theme snippet)

  Usage:
  - Include it in theme.liquid before </body>
  - Or include only on product pages

  Updated for schema:
  - fake_orders_min_minutes: 1..121 step 2
  - fake_orders_names / fake_orders_cities: textarea -> split into arrays
  - fake_orders_template_suffix: optional text (may be blank)
{%- endcomment -%}

{%- if settings.fake_orders_enabled -%}
  {%- assign _names = settings.fake_orders_names | newline_to_br | split: '<br />' -%}
  {%- assign _cities = settings.fake_orders_cities | newline_to_br | split: '<br />' -%}

  <div id="fakeOrderPopup" class="fake-order-popup" aria-live="polite" style="display:none;">
    <button class="fake-order-close" type="button" aria-label="Close">Ã—</button>

    <div class="fake-order-inner">
      {%- if settings.fake_orders_show_image and product and product.featured_image -%}
        <div class="fake-order-img">
          <img
            src="{{ product.featured_image | image_url: width: 120 }}"
            alt="{{ product.title | escape }}"
            loading="lazy"
            width="60"
            height="60"
          >
        </div>
      {%- endif -%}

      <div class="fake-order-text">
        <div class="fake-order-line1">
          <strong class="fo-name">Someone</strong>
          from <span class="fo-city">a city</span>
        </div>
        <div class="fake-order-line2">
          purchased <strong class="fo-product">this item</strong>
        </div>
        <div class="fake-order-line3">
          <span class="fo-time">just now</span>
        </div>
      </div>
    </div>
  </div>

  <style>
    .fake-order-popup{
      position: fixed;
      left: 16px;
      bottom: 16px;
      z-index: 9999;
      max-width: 360px;
      width: calc(100% - 32px);
      background: #fff;
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
      padding: 12px 12px;
      font-size: 14px;
      line-height: 1.25;
    }
    .fake-order-inner{ display:flex; gap:10px; align-items:center; }
    .fake-order-img img{ border-radius: 10px; display:block; }
    .fake-order-line1, .fake-order-line2, .fake-order-line3{ margin: 2px 0; }
    .fake-order-close{
      position:absolute;
      top: 6px;
      right: 8px;
      border: 0;
      background: transparent;
      font-size: 20px;
      line-height: 1;
      cursor: pointer;
      opacity: .65;
    }
    .fake-order-close:hover{ opacity: 1; }
    .fake-order-popup.is-show{ display:block; animation: foIn .25s ease; }
    .fake-order-popup.is-hide{ animation: foOut .2s ease; }
    @keyframes foIn{ from{ transform: translateY(10px); opacity:0;} to{ transform: translateY(0); opacity:1;} }
    @keyframes foOut{ from{ transform: translateY(0); opacity:1;} to{ transform: translateY(10px); opacity:0;} }
  </style>

  <script>
    (function(){
      // Basic targeting control
      var showOn = "{{ settings.fake_orders_show_on }}"; // all, product, home
      var pageType = {{ request.page_type | json }};
      var isProduct = pageType === "product";
      var isHome = pageType === "index";

      if (showOn === "product" && !isProduct) return;
      if (showOn === "home" && !isHome) return;

      // Optional: Only show on specific product template suffix
      var onlySuffix = "{{ settings.fake_orders_template_suffix | escape }}";
      {% if product and product.template_suffix %}
        var currentSuffix = {{ product.template_suffix | json }};
      {% else %}
        var currentSuffix = "";
      {% endif %}
      if (onlySuffix && isProduct && currentSuffix !== onlySuffix) return;

      var popup = document.getElementById("fakeOrderPopup");
      if (!popup) return;

      var closeBtn = popup.querySelector(".fake-order-close");
      var elName = popup.querySelector(".fo-name");
      var elCity = popup.querySelector(".fo-city");
      var elProd = popup.querySelector(".fo-product");
      var elTime = popup.querySelector(".fo-time");

      // Fake data (textarea -> arrays via Liquid)
      var names = {{ _names | json }};
      var cities = {{ _cities | json }};

      // Minutes range (schema: min 1..121 step 2, max 10..720 step 10)
      var minMinutes = Number({{ settings.fake_orders_min_minutes | json }}) || 5;
      var maxMinutes = Number({{ settings.fake_orders_max_minutes | json }}) || 120;

      // Ensure min <= max (in case user sets weird values)
      if (minMinutes > maxMinutes) {
        var tmp = minMinutes; minMinutes = maxMinutes; maxMinutes = tmp;
      }

      // Product text
      var productTitle = {{ product.title | default: "this item" | escape | json }};

      // Timing
      var minDelay = Number({{ settings.fake_orders_min_delay | json }}) || 6000;   // ms
      var maxDelay = Number({{ settings.fake_orders_max_delay | json }}) || 14000; // ms
      var showFor  = Number({{ settings.fake_orders_show_for | json }}) || 5500;   // ms

      // Clean arrays (trim + remove empty)
      function clean(arr){
        return (arr || []).map(function(x){ return (x || "").trim(); }).filter(Boolean);
      }
      names = clean(names);
      cities = clean(cities);

      function pick(arr, fallback){
        if (!arr || !arr.length) return fallback;
        return arr[Math.floor(Math.random() * arr.length)];
      }

      function rand(min, max){
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }

      function formatTime(mins){
        if (mins <= 1) return "just now";
        if (mins < 60) return mins + " minutes ago";
        var hours = Math.round(mins / 60);
        return hours + (hours === 1 ? " hour ago" : " hours ago");
      }

      var stopped = false;
      var hideTimer = null;
      var loopTimer = null;

      function showOnce(){
        if (stopped) return;

        var name = pick(names, "Someone");
        var city = pick(cities, "your area");
        var mins = rand(minMinutes, maxMinutes);

        elName.textContent = name;
        elCity.textContent = city;
        elProd.textContent = productTitle;
        elTime.textContent = formatTime(mins);

        popup.classList.remove("is-hide");
        popup.classList.add("is-show");

        clearTimeout(hideTimer);
        hideTimer = setTimeout(function(){
          popup.classList.add("is-hide");
          setTimeout(function(){
            popup.classList.remove("is-show");
            popup.classList.remove("is-hide");
          }, 220);
        }, showFor);

        scheduleNext();
      }

      function scheduleNext(){
        clearTimeout(loopTimer);
        loopTimer = setTimeout(showOnce, rand(minDelay, maxDelay));
      }

      closeBtn.addEventListener("click", function(){
        stopped = true;
        clearTimeout(hideTimer);
        clearTimeout(loopTimer);
        popup.style.display = "none";
      });

      // Start after a short delay
      setTimeout(showOnce, rand(1500, 3500));
    })();
  </script>
{%- endif -%}
