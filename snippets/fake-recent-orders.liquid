{%- comment -%}
  Fake Recent Orders Popup (Fade-in / Fade-out)
  - No display:none toggling (prevents flicker)
  - Smooth close (fade out) + hard stop
  - Random product each cycle from chosen collection
{%- endcomment -%}

{%- if settings.fake_orders_enabled -%}
  {%- assign _names = settings.fake_orders_names | newline_to_br | split: '<br />' -%}
  {%- assign _cities = settings.fake_orders_cities | newline_to_br | split: '<br />' -%}

  {%- assign _limit = settings.fake_orders_products_limit | default: 30 -%}

  {%- assign _col = blank -%}
  {%- if settings.fake_orders_source_collection != blank -%}
    {%- assign _col = collections[settings.fake_orders_source_collection] -%}
  {%- endif -%}
  {%- if _col == blank or _col == empty -%}
    {%- assign _col = collections.all -%}
  {%- endif -%}

  {%- capture products_json -%}
    [
      {%- if _col and _col.products_count > 0 -%}
        {%- for p in _col.products limit: _limit -%}
          {%- assign img = '' -%}
          {%- if p.featured_image != blank -%}
            {%- assign img = p.featured_image | image_url: width: 120 -%}
          {%- endif -%}
          {
            "title": {{ p.title | escape | json }},
            "url": {{ p.url | json }},
            "img": {{ img | json }}
          }{% unless forloop.last %},{% endunless %}
        {%- endfor -%}
      {%- endif -%}
    ]
  {%- endcapture -%}

  <div id="fakeOrderPopup" class="fake-order-popup" aria-live="polite">
    <button class="fake-order-close" type="button" aria-label="Close">Ã—</button>

    <a class="fake-order-link" href="#" style="text-decoration:none; color:inherit;">
      <div class="fake-order-inner">
        <div class="fake-order-img">
          <img class="fo-img" src="" alt="" loading="lazy" width="60" height="60">
        </div>

        <div class="fake-order-text">
          <div class="fake-order-line1">
            <strong class="fo-name">Someone</strong>
            from <strong class="fo-city">a city</strong>
          </div>
          <div class="fake-order-line2">
            purchased <strong class="fo-product">a product</strong>
          </div>
          <div class="fake-order-line3">
            <span class="fo-time">just now</span>
          </div>
        </div>
      </div>
    </a>
  </div>

  <style>
    .fake-order-popup{
      position: fixed;
      left: 16px;
      bottom: 16px;
      z-index: 9999;
      max-width: 360px;
      width: calc(100% - 32px);
      background: #fff;
      border: 1px solid rgba(0,0,0,.12);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
      padding: 12px;
      font-size: 14px;
      line-height: 1.25;

      /* Hidden state (no display:none) */
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
      transform: translateY(10px);

      transition: opacity .28s ease, transform .28s ease, visibility 0s linear .28s;
      will-change: opacity, transform;
    }

    /* Visible state */
    .fake-order-popup.is-visible{
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
      transform: translateY(0);
      transition: opacity .28s ease, transform .28s ease, visibility 0s;
    }

    .fake-order-inner{ display:flex; gap:10px; align-items:center; }
    .fake-order-img img{ border-radius: 10px; display:block; }
    .fake-order-line1, .fake-order-line2, .fake-order-line3{ margin: 2px 0; }

    .fake-order-close{
      position:absolute;
      top: 6px;
      right: 8px;
      z-index: 2;
      border: 0;
      background: transparent;
      font-size: 20px;
      line-height: 1;
      cursor: pointer;
      opacity: .65;
    }
    .fake-order-close:hover{ opacity: 1; }
  </style>

  <script>
    (function(){
      var showOn = "{{ settings.fake_orders_show_on }}";
      var pageType = {{ request.page_type | json }};
      var isProduct = pageType === "product";
      var isHome = pageType === "index";

      if (showOn === "product" && !isProduct) return;
      if (showOn === "home" && !isHome) return;

      // Remove duplicates
      var popups = document.querySelectorAll("#fakeOrderPopup");
      if (popups.length > 1) {
        for (var i = 0; i < popups.length - 1; i++) popups[i].remove();
      }

      var popup = document.getElementById("fakeOrderPopup");
      if (!popup) return;

      var closeBtn = popup.querySelector(".fake-order-close");
      var elName = popup.querySelector(".fo-name");
      var elCity = popup.querySelector(".fo-city");
      var elProd = popup.querySelector(".fo-product");
      var elTime = popup.querySelector(".fo-time");
      var linkEl = popup.querySelector(".fake-order-link");
      var imgEl  = popup.querySelector(".fo-img");
      var imgWrap = popup.querySelector(".fake-order-img");

      var names = {{ _names | json }};
      var cities = {{ _cities | json }};
      var products = {{ products_json | strip_newlines }};

      function clean(arr){
        return (arr || []).map(function(x){ return (x || "").trim(); }).filter(Boolean);
      }
      names = clean(names);
      cities = clean(cities);

      var minMinutes = Number({{ settings.fake_orders_min_minutes | json }}) || 5;
      var maxMinutes = Number({{ settings.fake_orders_max_minutes | json }}) || 120;
      if (minMinutes > maxMinutes) { var t = minMinutes; minMinutes = maxMinutes; maxMinutes = t; }

      var showFor = Number({{ settings.fake_orders_show_for | json }}) || 5500;
      var delayBetween = Number({{ settings.fake_orders_delay | json }}) || 12000;

      if (showFor < 1500) showFor = 1500;
      if (delayBetween < 1000) delayBetween = 1000;

      function pick(arr, fallback){
        if (!arr || !arr.length) return fallback;
        return arr[Math.floor(Math.random() * arr.length)];
      }
      function rand(min, max){
        return Math.floor(Math.random() * (max - min + 1)) + min;
      }
      function formatTime(mins){
        if (mins <= 1) return "just now";
        if (mins < 60) return mins + " minutes ago";
        var hours = Math.round(mins / 60);
        return hours + (hours === 1 ? " hour ago" : " hours ago");
      }
      function pickProduct(){
        if (!products || !products.length) return null;
        return products[Math.floor(Math.random() * products.length)];
      }
      function setProduct(p){
        if (!p || !p.title) return false;

        elProd.textContent = p.title;
        linkEl.href = p.url || "#";
        linkEl.style.pointerEvents = p.url ? "auto" : "none";

        if (imgEl && imgWrap) {
          if (p.img) {
            imgEl.src = p.img;
            imgEl.alt = p.title;
            imgWrap.style.display = "block";
          } else {
            imgWrap.style.display = "none";
          }
        }
        return true;
      }

      // Timers
      var killed = false;
      var tStart=null, tHold=null, tNext=null;

      function clearTimers(){
        if (tStart) clearTimeout(tStart);
        if (tHold) clearTimeout(tHold);
        if (tNext)  clearTimeout(tNext);
        tStart=tHold=tNext=null;
      }

      function showPopup(){
        if (killed) return;

        var p = pickProduct();
        if (!setProduct(p)) return;

        elName.textContent = pick(names, "Someone");
        elCity.textContent = pick(cities, "your area");
        elTime.textContent = formatTime(rand(minMinutes, maxMinutes));

        popup.classList.add("is-visible");
      }

      function hidePopup(){
        if (killed) return;
        popup.classList.remove("is-visible");
      }

      function loop(){
        if (killed) return;

        showPopup();

        tHold = setTimeout(function(){
          tHold = null;
          hidePopup();

          tNext = setTimeout(function(){
            tNext = null;
            loop();
          }, delayBetween);

        }, showFor);
      }

      closeBtn.addEventListener("click", function(e){
        e.preventDefault();
        e.stopPropagation();
        if (killed) return;

        killed = true;
        clearTimers();

        // Smooth close: just fade out
        popup.classList.remove("is-visible");
      });

      if (!products || !products.length) return;

      tStart = setTimeout(function(){
        tStart = null;
        loop();
      }, 900);

    })();
  </script>
{%- endif -%}
