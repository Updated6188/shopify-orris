{%- comment -%}
  Orris â€“ Discovery Box 4 Testers (Line Item Properties)
  Shows only for specific product titles (change handles/titles if needed)
{%- endcomment -%}

{%- assign is_discovery = false -%}
{%- if product.handle == 'discovery-box-4-testers' -%}
  {%- assign is_discovery = true -%}
{%- endif -%}

{%- if is_discovery -%}
  {%- assign testers = "Orris Legend (Men)|White Oud (Unisex)|Secret Garden (Women)|Velvet Touch (Men)|Peru (Men)|Rebel Hearts (Women)" | split: "|" -%}

  <div class="orris-tester-box">
    <h2>
      Select Your 4 Testers (5 ml Each):
    </h2>
    <div class="select-grid">
    {%- for i in (1..4) -%}
      <div class="orris-dropdown">
        <label>
          Tester {{ i }}:
        </label>

        <select
          name="properties[Tester {{ i }}]"
          class="orris-tester-select"
          required
        >
          <option value="">-- Select Tester {{ i }} --</option>
          {%- for t in testers -%}
            <option value="{{ t | escape }}">{{ t }}</option>
          {%- endfor -%}
        </select>
      </div>
    {%- endfor -%}
    </div>
    <p class="tester-warning" style="color:red;display:none;">
      Please select all 4 testers before adding to cart.
    </p>
  </div>
  <script>
document.addEventListener('DOMContentLoaded', function () {
  const box = document.querySelector('.orris-tester-box');
  if (!box) return;

  const form =
    box.closest('form[action^="/cart/add"]') ||
    document.querySelector('form[action^="/cart/add"]');
  if (!form) return;

  const selects = box.querySelectorAll('.orris-tester-select');
  const warning = box.querySelector('.tester-warning');

  function validateSelections() {
    let valid = true;

    selects.forEach(sel => {
      if (!sel.value) {
        valid = false;
        sel.style.border = '2px solid red';
      } else {
        sel.style.border = ''; // reset to theme default
      }
    });

    return valid;
  }

  function showWarning() {
    if (warning) warning.style.display = 'block';
    box.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function hideWarning() {
    if (warning) warning.style.display = 'none';
  }

  function handleValidation(e) {
    if (!validateSelections()) {
      e.preventDefault();
      e.stopPropagation();
      showWarning();
      return false;
    }
    hideWarning();
  }

  // 1) Block normal submit
  form.addEventListener('submit', handleValidation, true);

  // 2) Block Add to cart click
  form.addEventListener('click', function (e) {
    const btn = e.target.closest('button[type="submit"], input[type="submit"]');
    if (!btn) return;
    handleValidation(e);
  }, true);

  // 3) Block Buy Now (dynamic checkout button)
  form.addEventListener('click', function (e) {
    const payBtn = e.target.closest(
      '.shopify-payment-button__button, .shopify-payment-button button, .shopify-payment-button input'
    );
    if (!payBtn) return;
    handleValidation(e);
  }, true);

  // 4) Remove red border immediately when selected
  selects.forEach(sel => {
    sel.addEventListener('change', function () {
      if (sel.value) sel.style.border = '';
      if (validateSelections()) hideWarning();
    });
  });
});
</script>
{%- endif -%}
