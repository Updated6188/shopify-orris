{%- comment -%}
  Orris â€“ Dynamic Tester Selector
  Supports multiple products + metafield driven options
{%- endcomment -%}

{%- assign tester_count = 0 -%}

{%- if product.handle == 'discovery-box-4-testers' -%}
  {%- assign tester_count = 4 -%}
{%- elsif product.handle == 'pack-of-2-50ml' -%}
  {%- assign tester_count = 2 -%}
{%- endif -%}

{%- assign tester_options = product.metafields.custom.tester_options.value -%}

{%- if tester_count > 0 and tester_options != blank -%}

  <div class="orris-tester-box" style="margin-bottom:20px;">
    <h2 class="ft-size-18 color-black fw-medium mb-2">
      Select Your {{ tester_count }} Tester{{ tester_count | pluralize }}:
    </h2>

    {%- for i in (1..tester_count) -%}
      <div class="orris-dropdown" style="margin-bottom:10px;">
        <label style="display:block;margin-bottom:5px;">
          Tester {{ i }}:
        </label>

        <select
          name="properties[Tester {{ i }}]"
          class="orris-tester-select"
          required
          style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;"
        >
          <option value="">-- Select Tester {{ i }} --</option>
          {%- for option in tester_options -%}
            <option value="{{ option | escape }}">{{ option }}</option>
          {%- endfor -%}
        </select>
      </div>
    {%- endfor -%}

    <p class="tester-warning" style="color:red;display:none;">
      Please select all {{ tester_count }} testers before adding to cart.
    </p>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const box = document.querySelector('.orris-tester-box');
      if (!box) return;

      const form = box.closest('form[action^="/cart/add"]');
      if (!form) return;

      const selects = box.querySelectorAll('.orris-tester-select');
      const warning = box.querySelector('.tester-warning');

      function allSelected() {
        return [...selects].every(sel => sel.value);
      }

      function block(e) {
        e.preventDefault();
        e.stopPropagation();
        warning.style.display = 'block';
        box.scrollIntoView({ behavior: 'smooth', block: 'start' });
        return false;
      }

      form.addEventListener('submit', function (e) {
        if (!allSelected()) return block(e);
        warning.style.display = 'none';
      }, true);

      form.addEventListener('click', function (e) {
        const btn = e.target.closest('button[type="submit"], input[type="submit"]');
        if (!btn) return;
        if (!allSelected()) return block(e);
        warning.style.display = 'none';
      }, true);

      selects.forEach(sel => {
        sel.addEventListener('change', () => {
          if (allSelected()) warning.style.display = 'none';
        });
      });
    });
  </script>

{%- endif -%}
